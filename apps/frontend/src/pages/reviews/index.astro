---
import MainLayout from '@/layouts/MainLayout.astro';
import ReviewsPage from '@/components/reviews/ReviewsPage';
import { getAllReviews } from '@/services/reviews';
import type { PaginatedReviewsResponse } from '@questlog/shared-types';

// This page is statically generated at build time
// On Vercel, you can enable ISR with revalidation

// ============================================================================
// Server-Side Data Fetching
// ============================================================================

let reviewsData: PaginatedReviewsResponse | null = null;

try {
  // Fetch the first page of reviews
  reviewsData = await getAllReviews({
    page: 1,
    limit: 20,
    sortBy: 'createdAt',
    sortOrder: 'desc',
  });
} catch (err: any) {
  // Log error but continue to render page
  console.error('Error fetching reviews:', err);
}

// ============================================================================
// SEO Meta Tags
// ============================================================================

const pageTitle = 'Recent Reviews | Questlog';
const pageDescription =
  'Browse the latest game reviews from the Questlog community. Discover honest opinions, detailed critiques, and recommendations for your next gaming adventure.';

// Open Graph image (you can replace with a custom reviews page image)
const pageImage = `${Astro.site || Astro.url.origin}/og-reviews.png`;

// Canonical URL
const canonicalURL = new URL('/reviews', Astro.site || Astro.url.origin).toString();

// Structured data for rich results
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'Recent Game Reviews',
  description: pageDescription,
  url: canonicalURL,
  ...(reviewsData && {
    numberOfItems: reviewsData.meta.total,
  }),
};

---

<MainLayout
  title={pageTitle}
  description={pageDescription}
  image={pageImage}
  canonicalURL={canonicalURL}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

  <!-- Reviews Page Content -->
  <ReviewsPage 
    initialData={reviewsData}
    client:load
  />
</MainLayout>
